#!/usr/bin/env ruby
# frozen_string_literal: true

#
# Parse `bin/releases.html`, extract URLs to all versions of jQuery,
# download them in parallel, and write them to public/js.
#
# Note: `bin/releases.html` is generated by `bin/fetch-html.rb`.
#
# Usage:
#
#   bin/fetch-jqueries.rb

# load libraries
require 'net/https'
require 'nokogiri'
require 'uri'

CSS = 'a[href*=".min."]'

# load html
HTML = File.read(File.join(__dir__, 'releases.html'))

# parse html, get minified uris, fetch uris in threads
(Nokogiri::HTML(HTML) / CSS).map { |e|
  URI.parse(e['href']) # parse uri
}.select { |uri|
  # require https prefix, exclude migrate
  (uri.scheme == 'https') && !uri.path.match(/migrate/)
}.map do |uri|
  Thread.new(uri) do |s|
    # build destination path
    dst = File.join(__dir__, '..', 'public', 'js', File.basename(uri.path))

    # write data
    File.write(dst, Net::HTTP.get(uri))
  end
end.each { |t| t.join }
